{
  "info": {
    "name": "Local Energy Market API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:3000" },
    { "key": "producerToken", "value": "" },
    { "key": "consumerToken", "value": "" },
    { "key": "consumer2Token", "value": "" },
    { "key": "reservationId", "value": "" },
    { "key": "reservationId2", "value": "" },
    { "key": "tomorrow", "value": "{{todayPlus1}}" }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "exec": [
          "const d=new Date(); d.setDate(d.getDate()+2); const pad=n=>String(n).padStart(2,'0');",
          "pm.variables.set('todayPlus1',`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`);"
        ],
        "type": "text/javascript"
      }
    }
  ],
  "item": [
    {
      "name": "Auth - Register Producer",
      "request": {
        "method": "POST",
        "header": [{ "key": "Content-Type", "value": "application/json" }],
        "url": "{{baseUrl}}/api/auth/register",
        "body": { "mode": "raw", "raw": "{\n  \"email\": \"producer@example.com\",\n  \"password\": \"prod12345\",\n  \"name\": \"Producer One\",\n  \"role\": \"producer\"\n}" }
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 201/409', function(){ pm.expect([201,409]).to.include(pm.response.code); });"]}}]
    },
    {
      "name": "Auth - Register Consumer 1",
      "request": {
        "method": "POST",
        "header": [{ "key": "Content-Type", "value": "application/json" }],
        "url": "{{baseUrl}}/api/auth/register",
        "body": { "mode": "raw", "raw": "{\n  \"email\": \"consumer@example.com\",\n  \"password\": \"cons12345\",\n  \"name\": \"Consumer One\",\n  \"role\": \"consumer\"\n}" }
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 201/409', function(){ pm.expect([201,409]).to.include(pm.response.code); });"]}}]
    },
    {
      "name": "Auth - Register Consumer 2",
      "request": {
        "method": "POST",
        "header": [{ "key": "Content-Type", "value": "application/json" }],
        "url": "{{baseUrl}}/api/auth/register",
        "body": { "mode": "raw", "raw": "{\n  \"email\": \"consumer2@example.com\",\n  \"password\": \"cons22345\",\n  \"name\": \"Consumer Two\",\n  \"role\": \"consumer\"\n}" }
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 201/409', function(){ pm.expect([201,409]).to.include(pm.response.code); });"]}}]
    },
    {
      "name": "Auth - Login Producer",
      "request": {
        "method": "POST",
        "header": [{ "key": "Content-Type", "value": "application/json" }],
        "url": "{{baseUrl}}/api/auth/login",
        "body": { "mode": "raw", "raw": "{\n  \"email\": \"producer@example.com\",\n  \"password\": \"prod12345\"\n}" }
      },
      "event": [{
        "listen": "test",
        "script": {"exec": ["pm.test('status 200', function(){ pm.response.to.have.status(200); });","pm.collectionVariables.set('producerToken', pm.response.json().token);"]}
      }]
    },
    {
      "name": "Auth - Login Consumer 1",
      "request": {
        "method": "POST",
        "header": [{ "key": "Content-Type", "value": "application/json" }],
        "url": "{{baseUrl}}/api/auth/login",
        "body": { "mode": "raw", "raw": "{\n  \"email\": \"consumer@example.com\",\n  \"password\": \"cons12345\"\n}" }
      },
      "event": [{
        "listen": "test",
        "script": {"exec": ["pm.test('status 200', function(){ pm.response.to.have.status(200); });","pm.collectionVariables.set('consumerToken', pm.response.json().token);"]}
      }]
    },
    {
      "name": "Auth - Login Consumer 2",
      "request": {
        "method": "POST",
        "header": [{ "key": "Content-Type", "value": "application/json" }],
        "url": "{{baseUrl}}/api/auth/login",
        "body": { "mode": "raw", "raw": "{\n  \"email\": \"consumer2@example.com\",\n  \"password\": \"cons22345\"\n}" }
      },
      "event": [{
        "listen": "test",
        "script": {"exec": ["pm.test('status 200', function(){ pm.response.to.have.status(200); });","pm.collectionVariables.set('consumer2Token', pm.response.json().token);"]}
      }]
    },
    {
      "name": "Producer - Create Profile",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{producerToken}}" }
        ],
        "url": "{{baseUrl}}/api/producer/profile",
        "body": { "mode": "raw", "raw": "{\n  \"energyType\": \"Fotovoltaico\",\n  \"co2PerKwh\": 45,\n  \"pricePerKwh\": 0.25,\n  \"defaultMaxPerHourKwh\": 60\n}" }
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 200', function(){ pm.expect([200,201]).to.include(pm.response.code); });"]}}]
    },
    {
      "name": "Producer - Set Capacities Tomorrow",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{producerToken}}" }
        ],
        "url": "{{baseUrl}}/api/producer/capacities",
        "body": { "mode": "raw", "raw": "{\n  \"date\": \"{{tomorrow}}\",\n  \"slots\": [\n    { \"hour\": 10, \"maxCapacityKwh\": 10, \"pricePerKwh\": 0.22 },\n    { \"hour\": 11, \"maxCapacityKwh\": 10, \"pricePerKwh\": 0.22 }\n  ]\n}" }
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 200', function(){ pm.response.to.have.status(200); });"]}}]
    },
    {
      "name": "Consumer1 - Reserve Slot 10h (8kWh)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{consumerToken}}" }
        ],
        "url": "{{baseUrl}}/api/consumer/reserve",
        "body": { "mode": "raw", "raw": "{\n  \"producerId\": 1,\n  \"date\": \"{{tomorrow}}\",\n  \"hour\": 10,\n  \"kwh\": 8\n}" }
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 201', function(){ pm.response.to.have.status(201); });","pm.collectionVariables.set('reservationId', pm.response.json().id);"]}}]
    },
    {
      "name": "Consumer2 - Reserve Slot 10h (8kWh)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{consumer2Token}}" }
        ],
        "url": "{{baseUrl}}/api/consumer/reserve",
        "body": { "mode": "raw", "raw": "{\n  \"producerId\": 1,\n  \"date\": \"{{tomorrow}}\",\n  \"hour\": 10,\n  \"kwh\": 8\n}" }
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 201 or 400 cap', function(){ pm.expect([201,400]).to.include(pm.response.code); });","if(pm.response.code===201){pm.collectionVariables.set('reservationId2', pm.response.json().id);} "]}}]
    },
    {
      "name": "Producer - Occupancy Tomorrow",
      "request": {
        "method": "GET",
        "header": [{ "key": "Authorization", "value": "Bearer {{producerToken}}" }],
        "url": "{{baseUrl}}/api/producer/occupancy?date={{tomorrow}}&fromHour=10&toHour=11"
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 200', function(){ pm.response.to.have.status(200); });"]}}]
    },
    {
      "name": "Producer - Proportional Accept (10h)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{producerToken}}" }
        ],
        "url": "{{baseUrl}}/api/producer/proportional-accept",
        "body": { "mode": "raw", "raw": "{\n  \"date\": \"{{tomorrow}}\",\n  \"hour\": 10\n}" }
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 200', function(){ pm.response.to.have.status(200); });"]}}]
    },
    {
      "name": "Consumer - Modify Reservation (use captured id)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{consumerToken}}" }
        ],
        "url": "{{baseUrl}}/api/consumer/modify",
        "body": { "mode": "raw", "raw": "{\n  \"reservationId\": {{reservationId}},\n  \"kwh\": 5.0\n}" }
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 200', function(){ pm.expect([200,400]).to.include(pm.response.code); });"]}}]
    },
    {
      "name": "Consumer - Cancel Reservation (use captured id)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{consumerToken}}" }
        ],
        "url": "{{baseUrl}}/api/consumer/modify",
        "body": { "mode": "raw", "raw": "{\n  \"reservationId\": {{reservationId}},\n  \"kwh\": 0\n}" }
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 200', function(){ pm.expect([200,404]).to.include(pm.response.code); });"]}}]
    },
    {
      "name": "Producer - Earnings",
      "request": {
        "method": "GET",
        "header": [
          { "key": "Authorization", "value": "Bearer {{producerToken}}" }
        ],
        "url": "{{baseUrl}}/api/producer/earnings?range={{tomorrow}}|{{tomorrow}}"
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 200', function(){ pm.response.to.have.status(200); });"]}}]
    },
    {
      "name": "Stats - Producer JSON",
      "request": {
        "method": "GET",
        "header": [{ "key": "Authorization", "value": "Bearer {{producerToken}}" }],
        "url": "{{baseUrl}}/api/stats/producer?range={{tomorrow}}|{{tomorrow}}&format=json"
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 200', function(){ pm.response.to.have.status(200); });"]}}]
    },
    {
      "name": "Stats - Producer Image",
      "request": {
        "method": "GET",
        "header": [
          { "key": "Authorization", "value": "Bearer {{producerToken}}" }
        ],
        "url": "{{baseUrl}}/api/stats/producer?range={{tomorrow}}|{{tomorrow}}&format=image"
      },
      "event": [{"listen": "test", "script": {"exec": ["pm.test('status 200', function(){ pm.response.to.have.status(200); });"]}}]
    }
  ]
}


